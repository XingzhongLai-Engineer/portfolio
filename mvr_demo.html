<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 强制禁止浏览器自动翻译，防止"Target Conc."被误翻为"目标会议" -->
    <meta name="google" content="notranslate" />
    <title>Glycine Double-Effect TVR Plate Evaporator Simulation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        /* --- New Control Panel Styles --- */
        .controls {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 120px;
            text-align: right;
        }
        .control-group span {
            font-size: 12px;
            color: #888;
        }

        .canvas-container {
            position: relative;
            background: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        .legend {
            margin-top: 15px;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #555;
            flex-wrap: wrap;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 5px;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .note {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            background: #eef;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>

    <h1>Glycine Double-Effect TVR Plate Evaporator System</h1>

    <!-- Control Panel -->
    <div class="controls">
        <div class="control-group">
            <label>Feed Flow Rate</label>
            <input type="number" id="inputFeedFlow" value="14590" step="100">
            <span>(kg/h)</span>
        </div>
        <div class="control-group">
            <label>Feed Concentration</label>
            <input type="number" id="inputFeedConc" value="23.55" step="0.1">
            <span>(%)</span>
        </div>
        <div class="control-group">
            <!-- Changed "Target Conc." to "Target Concentration" to avoid ambiguity -->
            <label>Target Concentration</label>
            <input type="number" id="inputTargetConc" value="40.0" step="0.5">
            <span>(%)</span>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="simCanvas" width="1000" height="600"></canvas>
    </div>
    
    <div class="legend">
        <div class="legend-item"><div class="dot" style="background:#87CEEB"></div>Feed / Dilute Liquid</div>
        <div class="legend-item"><div class="dot" style="background:#4682B4"></div>Concentrate</div>
        <div class="legend-item"><div class="dot" style="background:#FF6347"></div>Live Steam / Mixed Steam</div>
        <div class="legend-item"><div class="dot" style="background:#D3D3D3"></div>Secondary Vapor</div>
        <div class="legend-item"><div class="dot" style="background:#FFD700"></div>Condensate</div>
    </div>
    
    <div class="note">
        <strong>Note:</strong> To display real equipment photos, please name your photos as 
        <code>heater.png</code>, <code>separator.png</code>, <code>condenser.png</code>, 
        <code>tvr.png</code>, <code>tank.png</code>, <code>pump.png</code> 
        and place them in the same directory.
    </div>

<script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    let time = 0;

    // --- 1. Simulation State & Calculation Logic ---
    
    const state = {
        feedFlow: 14590, // kg/h
        feedConc: 23.55, // %
        targetConc: 40.0, // %
        // Calculated values
        prodFlow: 0,
        totalEvap: 0,
        w1: 0,
        w2: 0,
        steamFlow: 0,
        mixedCondensate: 0,
        endCondensate: 0,
        cwFlow: 0
    };

    function calculateBalance() {
        // Basic Mass Balance: F * Xf = P * Xp
        // P = F * (Xf / Xp)
        state.prodFlow = state.feedFlow * (state.feedConc / state.targetConc);
        state.totalEvap = state.feedFlow - state.prodFlow;

        // Effect Distribution (Based on TVR design: ~65% in 1st Effect, ~35% in 2nd Effect)
        state.w1 = state.totalEvap * 0.65;
        state.w2 = state.totalEvap * 0.35;

        // Steam Consumption (TVR efficiency approx 0.4 kg steam per kg total water)
        state.steamFlow = state.totalEvap * 0.4;

        // Condensate Balance
        // Mixed Condensate = Live Steam + W1 (since W1 heat comes from Steam+TVR recycle)
        // Note: E1 Shell Side = Motive Steam + Suction. E2 Shell Side = W1 - Suction.
        // Total Heating Condensate (collected in bottom tank) = Motive + W1.
        state.mixedCondensate = state.steamFlow + state.w1;

        // End Condensate (from Condenser) = W2
        state.endCondensate = state.w2;

        // Cooling Water (Scale: 200m3 for 2100kg/h vapor)
        // Ratio approx 0.095 m3/kg vapor
        state.cwFlow = state.w2 * (200 / 2100);
    }

    // Input Listeners
    const inputFeedFlow = document.getElementById('inputFeedFlow');
    const inputFeedConc = document.getElementById('inputFeedConc');
    const inputTargetConc = document.getElementById('inputTargetConc');

    function updateInputs() {
        state.feedFlow = parseFloat(inputFeedFlow.value) || 0;
        state.feedConc = parseFloat(inputFeedConc.value) || 0;
        state.targetConc = parseFloat(inputTargetConc.value) || 1; // avoid div by zero
        calculateBalance();
    }

    inputFeedFlow.addEventListener('input', updateInputs);
    inputFeedConc.addEventListener('input', updateInputs);
    inputTargetConc.addEventListener('input', updateInputs);

    // Initial calculation
    calculateBalance();


    // --- 2. Image Resource Loading ---
    const images = {
        heater: new Image(),
        separator: new Image(),
        condenser: new Image(),
        tvr: new Image(),
        tank: new Image(),
        pump: new Image()
    };

    function initImage(key, filename, labelText, width=100, height=100) {
        const img = images[key];
        img.onerror = function() {
            img.src = `https://placehold.co/${width}x${height}/e0e0e0/333333?text=${labelText}`;
            img.onerror = null;
        };
        img.src = filename;
    }

    initImage('heater',    'heater.png',    'Heater', 60, 150);
    initImage('separator', 'separator.png', 'Separator', 80, 160);
    initImage('condenser', 'condenser.png', 'Condenser', 60, 100);
    initImage('tvr',       'tvr.png',       'TVR',    80, 80);
    initImage('tank',      'tank.png',      'Tank',   50, 60);
    initImage('pump',      'pump.png',      'Pump',     40, 40);

    // --- 3. Color Config ---
    const colors = {
        feed: '#87CEEB', conc1: '#5F9EA0', conc2: '#4682B4',
        steam: '#FF6347', vapor: '#D3D3D3', condensate: '#FFD700',
        cw: '#00CED1', text: '#333'
    };

    // --- 4. Drawing Helpers ---
    function formatNum(num) {
        return num.toLocaleString('en-US', {maximumFractionDigits: 0});
    }

    function drawHeater(img, x, y, w, h, label) {
        ctx.drawImage(img, x, y, w, h);
        ctx.fillStyle = colors.text;
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, x + w/2, y + h + 15);
    }

    function drawSeparator(img, centerX, centerY, label) {
        const w = 80; const h = 160; 
        ctx.drawImage(img, centerX - w/2, centerY - h/2, w, h);
        ctx.fillStyle = colors.text;
        ctx.textAlign = 'center';
        ctx.fillText(label, centerX, centerY + h/2 + 15);
    }

    function drawTank(img, centerX, centerY, label) {
        const w = 50; const h = 60;
        ctx.drawImage(img, centerX - w/2, centerY - h/2, w, h);
        ctx.fillStyle = colors.text;
        ctx.textAlign = 'center';
        ctx.fillText(label, centerX, centerY + h/2 + 15);
    }

    function drawPump(img, centerX, centerY) {
        const size = 30;
        ctx.drawImage(img, centerX - size/2, centerY - size/2, size, size);
    }

    function drawTVR(img, centerX, centerY) {
        const w = 80; const h = 80;
        ctx.drawImage(img, centerX - w/2, centerY - h/2, w, h);
        ctx.fillStyle = colors.text;
        ctx.textAlign = 'center';
        ctx.fillText("TVR", centerX, centerY - h/2 - 10);
    }

    function drawPipe(points, color, width=2, dash=true) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineJoin = 'round';
        if (dash) {
            ctx.setLineDash([8, 4]);
            ctx.lineDashOffset = -time * 1;
        } else {
            ctx.setLineDash([]);
        }
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // --- 5. Main Animation Loop ---
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        time += 1;

        // Layer 1: Pipes
        drawPipe([{x:80, y:420}, {x:80, y:450}, {x:200, y:450}, {x:200, y:350}, {x:320, y:350}], colors.feed);
        drawPipe([{x:450, y:330}, {x:450, y:400}, {x:550, y:400}, {x:550, y:350}, {x:620, y:350}], colors.conc1);
        drawPipe([{x:750, y:330}, {x:750, y:480}, {x:850, y:480}], colors.conc2);
        drawPipe([{x:350, y:20}, {x:350, y:60}], colors.steam, 4);
        drawPipe([{x:350, y:140}, {x:350, y:200}], colors.steam, 4);
        drawPipe([{x:450, y:190}, {x:450, y:100}, {x:390, y:100}], colors.vapor); 
        drawPipe([{x:450, y:190}, {x:500, y:190}, {x:500, y:150}, {x:650, y:150}, {x:650, y:200}], colors.vapor); 
        drawPipe([{x:750, y:190}, {x:750, y:100}, {x:880, y:100}, {x:880, y:120}], colors.vapor); 
        drawPipe([{x:350, y:350}, {x:350, y:520}, {x:400, y:520}], colors.condensate);
        drawPipe([{x:650, y:350}, {x:650, y:520}, {x:400, y:520}], colors.condensate);
        drawPipe([{x:400, y:520}, {x:240, y:520}, {x:240, y:480}], colors.condensate); 
        drawPipe([{x:240, y:420}, {x:240, y:380}, {x:100, y:380}], colors.condensate); 
        drawPipe([{x:920, y:250}, {x:920, y:200}], colors.cw);
        drawPipe([{x:920, y:120}, {x:920, y:80}], colors.cw);
        drawPipe([{x:900, y:250}, {x:950, y:250}, {x:950, y:330}], '#aaa', 1);
        drawPipe([{x:380, y:240}, {x:410, y:240}], colors.conc1, 4, false); 
        drawPipe([{x:680, y:240}, {x:710, y:240}], colors.conc2, 4, false); 

        // Layer 2: Equipment
        drawHeater(images.heater, 320, 200, 60, 150, "E-101 1st Effect");
        drawHeater(images.heater, 620, 200, 60, 150, "E-102 2nd Effect");
        drawHeater(images.heater, 200, 420, 40, 60, "E-103 Preheater");
        drawHeater(images.condenser, 850, 120, 70, 110, "Condenser");
        drawSeparator(images.separator, 450, 250, "S-101");
        drawSeparator(images.separator, 750, 250, "S-102");
        drawTank(images.tank, 80, 450, "Feed Tank");
        drawTank(images.tank, 400, 520, "Condensate Tank");
        drawTVR(images.tvr, 350, 100);
        drawPump(images.pump, 140, 450); 
        drawPump(images.pump, 500, 400); 
        drawPump(images.pump, 750, 480); 
        drawPump(images.pump, 950, 350); 

        // Layer 3: Dynamic Text
        ctx.fillStyle = '#d32f2f'; 
        ctx.font = '11px Arial';
        ctx.textAlign = 'center';
        
        ctx.fillText("0.5MPa Live Steam", 350, 15);
        ctx.fillText(`Flow: ~${formatNum(state.steamFlow)} kg/h`, 350, 30);
        ctx.fillText("Mixed Steam 80°C", 280, 170);

        ctx.fillStyle = '#FF8C00'; 
        // 1st Effect
        ctx.fillText("1st Effect Evap 70°C", 450, 240);
        ctx.fillText(`Evap: ${formatNum(state.w1)} kg/h`, 450, 255);
        ctx.fillText("-0.069 MPa", 450, 270);
        
        // 2nd Effect
        ctx.fillText("2nd Effect Evap 50°C", 750, 240);
        ctx.fillText(`Evap: ${formatNum(state.w2)} kg/h`, 750, 255);
        ctx.fillText("-0.088 MPa", 750, 270);
        
        ctx.fillStyle = '#1976d2'; 
        // Product
        ctx.fillText(`Prod Conc ~${state.targetConc}%`, 850, 480);
        ctx.fillText(`Flow: ~${formatNum(state.prodFlow)} kg/h`, 850, 495);

        ctx.fillStyle = '#00796b';
        // Feed
        ctx.fillText(`Feed ${state.feedConc}%`, 80, 410);
        ctx.fillText(`Flow: ${formatNum(state.feedFlow)} kg/h`, 80, 425);

        ctx.fillStyle = '#00CED1';
        // CW
        ctx.fillText(`CW: ~${formatNum(state.cwFlow)} m³/h`, 930, 225);

        ctx.fillStyle = '#CFB53B';
        // Mixed Condensate
        ctx.fillText("Mixed Condensate", 400, 565);
        ctx.fillText(`~${formatNum(state.mixedCondensate)} kg/h`, 400, 580);
        
        ctx.fillStyle = '#888'; 
        // End Condensate
        ctx.fillText("End Condensate", 930, 245);
        ctx.fillText(`~${formatNum(state.endCondensate)} kg/h`, 930, 260);

        requestAnimationFrame(animate);
    }

    animate();

</script>

</body>
</html>